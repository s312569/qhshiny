library(dplyr)
library(shiny)
library(stringr)
library(lubridate)
library(ggplot2)
library(plotly)
library(shinycssloaders)
library(survival)
library(survminer)
library(broom)
library(rio)
library(whisker)
library(condusco)
library(DBI)
library(data.table)
library(rio)
source("./utilities.R")
source("./data.R")
source("./timeline.R")
source("./survival.R")
source("./cumElements.R")

######################################################################
## UI
######################################################################

ui <- function() {
    navbarPage(
        "Oil Quality Analysis",
        tabPanel("History", historyUI()),
        tabPanel("Survival analysis", survivalUI()),
        tabPanel("Cumulative elements", cumulativeUI())
    )
}

######################################################################
## server
######################################################################

server <- function(session, input, output) {
    rvs <- reactiveValues()
    registerHistoryPlot(session, rvs, input, output)
    registerSurvival(session, rvs, input, output)
    registerCumulative(session, rvs, input, output)
}

######################################################################
## app
######################################################################

shinyApp(ui = ui,
         server = server,
         onStart = function() {
             cat("Doing application setup\n")
             oilCon <<- startDB()

             onStop(function() {
                 cat("Doing application cleanup\n")
                 dbDisconnect(oilCon)
             })
         })
